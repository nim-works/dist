name: CI
on:
  push:
    paths:
      - '**.cfg'
      - '**.nims'
      - '**.nim'
      - '**.nimble'
      - 'tests/**'
      - '.github/workflows/ci.yml'
  pull_request:
    paths:
      - '**.cfg'
      - '**.nims'
      - '**.nim'
      - '**.nimble'
      - 'tests/**'
      - '.github/workflows/ci.yml'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        branch: [version-1-4]
        target: [linux, macos, windows]
        include:
          - target: linux
            builder: ubuntu-18.04
          - target: macos
            builder: macos-10.15
          - target: windows
            builder: windows-2019
    name: '${{ matrix.target }} (${{ matrix.branch }})'
    runs-on: ${{ matrix.builder }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: dist

      - name: Setup Nim
        uses: alaviss/setup-nim@0.1.1
        with:
          path: nim
          version: ${{ matrix.branch }}

      - name: Run tests
        shell: bash
        run: |
          cd dist
          git submodule update --init .
          echo "--path=\"\$config\"" > nim.cfg

          # just do this manually for now

          cd testes
          nimble --accept install
          nimble test

          cd ../jason
          nimble --accept develop
          nimble test

          cd ../frosty
          nimble --accept develop
          nimble test

          cd ../criterion
          nimble --accept develop
          nimble test

          cd ../bump
          nimble --accept install
          nimble test

          cd ../gram
          nimble --accept develop
          nimble test

          cd ../cligen
          nimble --accept develop
          nimble test

          cd ../weave
          nimble --accept develop
          nimble test

#      - name: Build docs
#        if: ${{ matrix.docs }} == 'true'
#        shell: bash
#        run: |
#          cd dist
#          branch=${{ github.ref }}
#          branch=${branch##*/}
#          nimble doc --project --outdir:docs \
#            '--git.url:https://github.com/${{ github.repository }}' \
#            '--git.commit:${{ github.sha }}' \
#            "--git.devel:$branch" \
#            dist.nim
#          # Ignore failures for older Nim
#          cp docs/{the,}index.html || true

#      - name: Publish docs
#        if: >
#          github.event_name == 'push' && github.ref == 'refs/heads/master' &&
#          matrix.target == 'linux' && matrix.branch == 'devel'
#        uses: crazy-max/ghaction-github-pages@v1
#        with:
#          build_dir: dist/docs
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
